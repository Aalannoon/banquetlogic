<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seniority Scheduler</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: Arial; background:#f5f5f5; padding:20px; }
.section { background:#fff; padding:15px; border-radius:6px; margin-bottom:20px; }
input,select,button { padding:6px; margin:4px 0; }
table { border-collapse:collapse; width:100%; margin-top:15px; }
th,td { border:1px solid #ccc; padding:6px; text-align:center; cursor:pointer; }
th { background:#eee; }
.employee-row { font-weight:bold; text-align:left; }

.shift-4 { background:#c8f7c5; }
.shift-6 { background:#ffd59e; }
.shift-8 { background:#fff3a0; }
.shift-ot { background:#d5b3ff; }
.shift-sick { background:#b3d9ff; font-weight:bold; }

.vacation { background:#ddd; color:#666; font-style:italic; }

#editor {
  display:none;
  position:fixed;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  background:#fff;
  padding:15px;
  border:2px solid #333;
  z-index:1000;
}
</style>
</head>

<body>

<h1>Seniority Scheduler</h1>

<div class="section">
<button onclick="generateSchedule()">Generate Schedule</button>
<button onclick="exportPDF()">Export PDF</button>
</div>

<div class="section">
<h2 id="scheduleHeader"></h2>
<div id="schedule"></div>
</div>

<div id="editor">
<h3>Edit Day</h3>

<label>
<input type="radio" name="dayType" value="shift" checked>
Shift
</label>
<label>
<input type="radio" name="dayType" value="sick">
Sick
</label>

<div id="shiftEditor">
Start <input type="time" id="editStart"><br>
End <input type="time" id="editEnd"><br>
<label><input type="checkbox" id="editOT"> Overtime</label>
</div>

<br>
<button onclick="saveEdit()">Save</button>
<button onclick="closeEditor()">Cancel</button>
</div>

<script>
const { jsPDF } = window.jspdf;

let employees = JSON.parse(localStorage.getItem("employees")) || [];
let events = JSON.parse(localStorage.getItem("events")) || [];
let scheduleData = JSON.parse(localStorage.getItem("scheduleData")) || {};

let editTarget = null;

function saveAll(){
  localStorage.setItem("scheduleData",JSON.stringify(scheduleData));
}

function generateSchedule(){
  scheduleData = {};
  const sorted=[...employees].sort((a,b)=>a.seniority-b.seniority);

  events.forEach(ev=>{
    let need = ev.guests<=50?2:ev.guests<=150?4:ev.guests<=300?6:8;

    sorted.forEach(emp=>{
      if(need<=0) return;
      if(emp.vacations?.some(v=>ev.date>=v.start&&ev.date<=v.end)) return;

      if(!scheduleData[emp.name]) scheduleData[emp.name]={};
      if(scheduleData[emp.name][ev.date]) return;

      const start=new Date(ev.date+"T"+ev.start);
      const end=new Date(ev.date+"T"+ev.end);
      let paid=Math.max(4,Math.min(8,(end-start)/3600000));
      let schedH=paid>4?paid+0.5:paid;

      scheduleData[emp.name][ev.date]={
        type:"shift",
        start:ev.start,
        end:ev.end,
        paid,
        schedH,
        ot:false
      };
      need--;
    });
  });

  saveAll();
  renderSchedule();
}

function getWeek(){
  const t=new Date();
  const m=new Date(t);
  m.setDate(t.getDate()-((t.getDay()+6)%7));
  return [...Array(7)].map((_,i)=>{
    const d=new Date(m); d.setDate(m.getDate()+i);
    return d.toISOString().split("T")[0];
  });
}

function shiftClass(sh){
  if(sh.type==="sick") return "shift-sick";
  if(sh.ot) return "shift-ot";
  if(sh.paid>=8) return "shift-8";
  if(sh.paid>=6) return "shift-6";
  return "shift-4";
}

function renderSchedule(){
  const week=getWeek();
  const head=new Date(week[0]);
  scheduleHeader.textContent=head.toLocaleString("default",{month:"long",year:"numeric"});

  let html="<table><tr><th>Employee</th>";
  week.forEach(d=>{
    const dt=new Date(d);
    html+=`<th>${dt.toLocaleDateString("default",{weekday:"short"})} ${dt.getDate()}</th>`;
  });
  html+="</tr>";

  employees.forEach(emp=>{
    html+=`<tr><td class="employee-row">#${emp.seniority} ${emp.name}</td>`;
    week.forEach(d=>{
      const sh=scheduleData?.[emp.name]?.[d];
      if(sh){
        if(sh.type==="sick"){
          html+=`<td class="shift-sick" onclick="openEditor('${emp.name}','${d}')">SICK</td>`;
        } else {
          html+=`<td class="${shiftClass(sh)}" onclick="openEditor('${emp.name}','${d}')">
            ${sh.start}-${sh.end}<br>${sh.schedH}h
          </td>`;
        }
      } else {
        html+=`<td onclick="openEditor('${emp.name}','${d}')"></td>`;
      }
    });
    html+="</tr>";
  });

  schedule.innerHTML=html+"</table>";
}

function openEditor(name,date){
  editTarget={name,date};

  if(!scheduleData[name]) scheduleData[name]={};

  const sh=scheduleData[name][date];

  if(sh?.type==="sick"){
    document.querySelector('input[value="sick"]').checked=true;
    shiftEditor.style.display="none";
  } else {
    document.querySelector('input[value="shift"]').checked=true;
    shiftEditor.style.display="block";
    editStart.value=sh?.start||"";
    editEnd.value=sh?.end||"";
    editOT.checked=sh?.ot||false;
  }

  editor.style.display="block";
}

function closeEditor(){
  editor.style.display="none";
  editTarget=null;
}

function saveEdit(){
  const type=document.querySelector('input[name="dayType"]:checked').value;

  if(type==="sick"){
    scheduleData[editTarget.name][editTarget.date]={ type:"sick" };
  } else {
    const s=new Date("2000-01-01T"+editStart.value);
    const e=new Date("2000-01-01T"+editEnd.value);
    let paid=Math.max(4,(e-s)/3600000);
    let schedH=paid>4?paid+0.5:paid;

    scheduleData[editTarget.name][editTarget.date]={
      type:"shift",
      start:editStart.value,
      end:editEnd.value,
      paid,
      schedH,
      ot:editOT.checked
    };
  }

  saveAll();
  closeEditor();
  renderSchedule();
}

function exportPDF(){
  const doc=new jsPDF({orientation:"landscape"});
  doc.html(document.querySelector("#schedule"),{
    callback:()=>doc.save("schedule.pdf"),
    x:10,y:10,width:270
  });
}

renderSchedule();
</script>

</body>
</html>
