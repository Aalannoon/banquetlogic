<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seniority Scheduler</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#f3f6fb;
  --card:#ffffff;
  --primary:#2563eb;
  --danger:#dc2626;
  --muted:#6b7280;
}

body{
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background:var(--bg);
  margin:0;
  padding:20px;
}

h1{ margin-bottom:10px; }
h2{ margin:0 0 10px; }

.container{
  max-width:1400px;
  margin:auto;
}

.card{
  background:var(--card);
  border-radius:10px;
  padding:16px;
  margin-bottom:20px;
  box-shadow:0 8px 24px rgba(0,0,0,.05);
}

button{
  padding:8px 14px;
  border:none;
  border-radius:6px;
  font-weight:600;
  cursor:pointer;
}

.btn-primary{ background:var(--primary); color:white; }
.btn-danger{ background:var(--danger); color:white; }
.btn-secondary{ background:#e5e7eb; }

button:hover{ opacity:.9; }

table{
  width:100%;
  border-collapse:collapse;
  background:white;
}

th{
  background:#eef2ff;
  position:sticky;
  top:0;
  z-index:2;
}

th,td{
  border:1px solid #e5e7eb;
  padding:8px;
  text-align:center;
}

.employee-row{
  font-weight:700;
  text-align:left;
  background:#f9fafb;
}

td:hover{ outline:2px solid var(--primary); }

.shift-4{ background:#c8f7c5; }
.shift-6{ background:#ffd59e; }
.shift-8{ background:#fff3a0; }
.shift-ot{ background:#d5b3ff; }
.shift-sick{ background:#b3d9ff; font-weight:700; }

.vacation{
  background:#e5e7eb;
  color:#6b7280;
  font-style:italic;
}

/* Modal */
#overlay{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  z-index:999;
}

#editor{
  display:none;
  position:fixed;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  background:white;
  padding:20px;
  border-radius:12px;
  width:320px;
  z-index:1000;
}

input[type="time"]{
  width:100%;
  padding:6px;
  margin-bottom:8px;
}

.legend span{
  display:inline-block;
  padding:4px 8px;
  border-radius:4px;
  margin-right:6px;
  font-weight:600;
}
</style>
</head>

<body>
<div class="container">

<h1>Seniority Scheduler</h1>

<div class="card">
  <button class="btn-primary" onclick="generateSchedule()">Generate Schedule</button>
  <button class="btn-secondary" onclick="exportPDF()">Export PDF</button>
</div>

<div class="card legend">
  <strong>Legend:</strong><br><br>
  <span class="shift-4">4h</span>
  <span class="shift-6">6h</span>
  <span class="shift-8">8h</span>
  <span class="shift-ot">OT</span>
  <span class="shift-sick">Sick</span>
  <span class="vacation">Vacation</span>
</div>

<div class="card">
  <h2 id="scheduleHeader"></h2>
  <div id="schedule"></div>
</div>

</div>

<div id="overlay"></div>

<div id="editor">
  <h3>Edit Day</h3>

  <label><input type="radio" name="dayType" value="shift" checked> Shift</label>
  <label><input type="radio" name="dayType" value="sick"> Sick</label>

  <div id="shiftEditor">
    <input type="time" id="editStart">
    <input type="time" id="editEnd">
    <label><input type="checkbox" id="editOT"> Overtime</label>
  </div>

  <br>
  <button class="btn-primary" onclick="saveEdit()">Save</button>
  <button class="btn-secondary" onclick="closeEditor()">Cancel</button>
</div>

<script>
const { jsPDF } = window.jspdf;
let employees=JSON.parse(localStorage.getItem("employees"))||[];
let events=JSON.parse(localStorage.getItem("events"))||[];
let scheduleData=JSON.parse(localStorage.getItem("scheduleData"))||{};
let editTarget=null;

function saveAll(){ localStorage.setItem("scheduleData",JSON.stringify(scheduleData)); }

function generateSchedule(){
  scheduleData={};
  employees.sort((a,b)=>a.seniority-b.seniority);

  events.forEach(ev=>{
    let need=ev.guests<=50?2:ev.guests<=150?4:ev.guests<=300?6:8;

    employees.forEach(emp=>{
      if(need<=0) return;
      if(emp.vacations?.some(v=>ev.date>=v.start&&ev.date<=v.end)) return;
      scheduleData[emp.name]??={};
      if(scheduleData[emp.name][ev.date]) return;

      const s=new Date(ev.date+"T"+ev.start);
      const e=new Date(ev.date+"T"+ev.end);
      let paid=Math.max(4,Math.min(8,(e-s)/3600000));
      let schedH=paid>4?paid+0.5:paid;

      scheduleData[emp.name][ev.date]={type:"shift",start:ev.start,end:ev.end,paid,schedH,ot:false};
      need--;
    });
  });

  saveAll(); renderSchedule();
}

function getWeek(){
  const t=new Date();
  const m=new Date(t);
  m.setDate(t.getDate()-((t.getDay()+6)%7));
  return [...Array(7)].map((_,i)=>{
    const d=new Date(m); d.setDate(m.getDate()+i);
    return d.toISOString().split("T")[0];
  });
}

function renderSchedule(){
  const week=getWeek();
  const head=new Date(week[0]);
  scheduleHeader.textContent=head.toLocaleString("default",{month:"long",year:"numeric"});

  let html="<table><tr><th>Employee</th>";
  week.forEach(d=>{
    const dt=new Date(d);
    html+=`<th>${dt.toLocaleDateString("default",{weekday:"short"})} ${dt.getDate()}</th>`;
  });
  html+="</tr>";

  employees.forEach(emp=>{
    html+=`<tr><td class="employee-row">#${emp.seniority} ${emp.name}</td>`;
    week.forEach(d=>{
      const sh=scheduleData?.[emp.name]?.[d];
      if(sh){
        html+=`<td class="${sh.type==="sick"?"shift-sick":sh.ot?"shift-ot":"shift-"+sh.paid}"
          onclick="openEditor('${emp.name}','${d}')">
          ${sh.type==="sick"?"SICK":`${sh.start}-${sh.end}<br>${sh.schedH}h`}
        </td>`;
      } else html+=`<td onclick="openEditor('${emp.name}','${d}')"></td>`;
    });
    html+="</tr>";
  });

  schedule.innerHTML=html+"</table>";
}

function openEditor(name,date){
  editTarget={name,date};
  scheduleData[name]??={};
  const sh=scheduleData[name][date];

  document.querySelector(`input[value="${sh?.type||"shift"}"]`).checked=true;
  shiftEditor.style.display=sh?.type==="sick"?"none":"block";
  editStart.value=sh?.start||"";
  editEnd.value=sh?.end||"";
  editOT.checked=sh?.ot||false;

  overlay.style.display="block";
  editor.style.display="block";
}

function closeEditor(){
  overlay.style.display="none";
  editor.style.display="none";
}

function saveEdit(){
  const type=document.querySelector('input[name="dayType"]:checked').value;
  if(type==="sick"){
    scheduleData[editTarget.name][editTarget.date]={type:"sick"};
  } else {
    const s=new Date("2000-01-01T"+editStart.value);
    const e=new Date("2000-01-01T"+editEnd.value);
    let paid=Math.max(4,(e-s)/3600000);
    let schedH=paid>4?paid+0.5:paid;

    scheduleData[editTarget.name][editTarget.date]={
      type:"shift",start:editStart.value,end:editEnd.value,
      paid,schedH,ot:editOT.checked
    };
  }
  saveAll(); closeEditor(); renderSchedule();
}

function exportPDF(){
  const doc=new jsPDF({orientation:"landscape"});
  doc.html(document.querySelector("#schedule"),{
    callback:()=>doc.save("schedule.pdf"),
    x:10,y:10,width:270
  });
}

renderSchedule();
</script>
</body>
</html>
